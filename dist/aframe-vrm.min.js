(()=>{var z=Object.create;var k=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var Y=o=>k(o,"__esModule",{value:!0});var S=o=>{if(typeof require!="undefined")return require(o);throw new Error('Dynamic require of "'+o+'" is not supported')};var Z=(o,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of G(e))!J.call(o,i)&&i!=="default"&&k(o,i,{get:()=>e[i],enumerable:!(t=q(e,i))||t.enumerable});return o},I=o=>Z(Y(k(o!=null?z(K(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);var C=class{constructor(e,t){this.target=null;this.angleLimit=60*Math.PI/180;this._identQ=new THREE.Quaternion;this._zV=new THREE.Vector3(0,0,-1);this._tmpQ0=new THREE.Quaternion;this._tmpV0=new THREE.Vector3;this._avatar=e}update(e){let t=this.target;if(t==null)return;let i=this._avatar.firstPersonBone;if(i==null)return;let s=i.worldToLocal(this._tmpV0.setFromMatrixPosition(t.matrixWorld)).normalize(),a=this._tmpQ0.setFromUnitVectors(this._zV,s),r=this.angleLimit,n=.08,l=2*Math.acos(a.w);l>r*1.5?(a=this._identQ,n=.04):l>r&&a.setFromAxisAngle(this._tmpV0.set(a.x,a.y,a.z).normalize(),r),i.quaternion.slerp(a,n)}};var O=class{constructor(e){this._currentShape={};this._avatar=e}setBlendShapeWeight(e,t){this._currentShape[e]=t,t==0&&delete this._currentShape[e],this._updateBlendShape()}getBlendShapeWeight(e){return this._currentShape[e]||0}resetBlendShape(){this._currentShape={},this._updateBlendShape()}startBlink(e){this.animatedMorph||(this.animatedMorph={name:"BLINK",times:[0,e-.2,e-.1,e],values:[0,0,1,0]},this._updateBlendShape())}stopBlink(){this.animatedMorph=null,this._updateBlendShape()}_updateBlendShape(){let e=(r,n,l)=>{let p=this._avatar.blendShapes[n];p&&p.binds.forEach(h=>{let d=h.target.name,E=r[d]||(r[d]=new Array(h.target.morphTargetInfluences.length*l.length).fill(0));for(let g=0;g<l.length;g++){let b=g*h.target.morphTargetInfluences.length+h.index;E[b]+=Math.max(h.weight*l[g],E[b])}})},t=[0],i={};this.animatedMorph&&(t=this.animatedMorph.times,e(i,this.animatedMorph.name,this.animatedMorph.values));for(let[r,n]of Object.entries(this._currentShape))this._avatar.blendShapes[r]&&e(i,r,new Array(t.length).fill(n));let s=Object.entries(i).map(([r,n])=>new THREE.NumberKeyframeTrack(r+".morphTargetInfluences",t,n)),a=null;if(s.length>0){let r=new THREE.AnimationClip("morph",void 0,s);a=this._avatar.mixer.clipAction(r).setEffectiveWeight(1).play()}this.morphAction&&this.morphAction.stop(),this.morphAction=a}};var F=class{constructor(e,t){this._firstPersonBone=e.firstPersonBone,this._annotatedMeshes=t.vrm.firstPerson.meshAnnotations.map(i=>({flag:i.firstPersonFlag,mesh:t.meshes[i.mesh]}))}setFirstPerson(e){this._annotatedMeshes.forEach(t=>{t.flag=="ThirdPersonOnly"?t.mesh.visible=!e:t.flag=="FirstPersonOnly"?t.mesh.visible=e:t.flag=="Auto"&&this._firstPersonBone&&(e?this._genFirstPersonMesh(t.mesh):this._resetFirstPersonMesh(t.mesh))})}_genFirstPersonMesh(e){if(e.children.forEach(d=>this._genFirstPersonMesh(d)),!e.isSkinnedMesh)return;let t={};this._firstPersonBone.traverse(d=>{t[d.uuid]=!0});let i=e.skeleton.bones,s=e.geometry.attributes.skinIndex,a=e.geometry.attributes.skinWeight,r=e.geometry.index,n=[],l=0,p=0;for(let d=0;d<s.array.length;d++){let E=s.array[d];a.array[d]>0&&t[i[E].uuid]&&(n[d/s.itemSize|0]||(l++,n[d/s.itemSize|0]=!0))}let h=[];for(let d=0;d<r.count;d++)n[r.array[d]]&&!h[d/3|0]&&(h[d/3|0]=!0,p++);if(p!=0&&p*3==r.count){e.visible=!1;return}}_resetFirstPersonMesh(e){e.children.forEach(t=>this._resetFirstPersonMesh(t)),e.visible=!0}};var L=class{constructor(e){this.bones={};this.blendShapes={};this.modules={};this.meta={};this.firstPersonBone=null;this._firstPersonMeshUtil=null;this.boneConstraints={head:{type:"ball",limit:60*Math.PI/180,twistAxis:new THREE.Vector3(0,1,0),twistLimit:60*Math.PI/180},neck:{type:"ball",limit:30*Math.PI/180,twistAxis:new THREE.Vector3(0,1,0),twistLimit:10*Math.PI/180},leftUpperLeg:{type:"ball",limit:170*Math.PI/180,twistAxis:new THREE.Vector3(0,-1,0),twistLimit:Math.PI/2},rightUpperLeg:{type:"ball",limit:170*Math.PI/180,twistAxis:new THREE.Vector3(0,-1,0),twistLimit:Math.PI/2},leftLowerLeg:{type:"hinge",axis:new THREE.Vector3(1,0,0),min:-170*Math.PI/180,max:0*Math.PI/180},rightLowerLeg:{type:"hinge",axis:new THREE.Vector3(1,0,0),min:-170*Math.PI/180,max:0*Math.PI/180}};this.model=e.scene,this.mixer=new THREE.AnimationMixer(this.model),this.isVRM=(e.userData.gltfExtensions||{}).VRM!=null,this.animations=e.animations||[],this._blendShapeUtil=new O(this)}static async load(e,t=[]){return new Promise((i,s)=>{new THREE.GLTFLoader(THREE.DefaultLoadingManager).load(e,async a=>{i(await new L(a).init(a,t))},void 0,s)})}async init(e,t){if(!this.isVRM){if(this.animations.length>0){let l=this.mixer.clipAction(this.animations[0]).setLoop(THREE.LoopOnce,1).play();l.clampWhenFinished=!0}return this}let i=e.userData.gltfExtensions.VRM,s=this.bones,a=await e.parser.getDependencies("node"),r=await e.parser.getDependencies("mesh"),n={nodes:a,meshes:r,vrm:i,gltf:e};this.meta=i.meta,Object.values(i.humanoid.humanBones).forEach(l=>{s[l.bone]=a[l.node]}),i.firstPerson&&i.firstPerson.firstPersonBone&&(this.firstPersonBone=a[i.firstPerson.firstPersonBone],this.modules.lookat=new C(this,n)),i.firstPerson&&i.firstPerson.meshAnnotations&&(this._firstPersonMeshUtil=new F(this,n)),this.model.skeleton=new THREE.Skeleton(Object.values(s)),this._fixBoundingBox(),i.blendShapeMaster&&this._initBlendShapes(n);for(let l of t){let p=l.instantiate(this,n);p&&(this.modules[l.name]=p)}return this}_initBlendShapes(e){this.blendShapes=(e.vrm.blendShapeMaster.blendShapeGroups||[]).reduce((t,i)=>{let s=i.binds.flatMap(a=>{let r=e.meshes[a.mesh];return(r.isSkinnedMesh?[r]:r.children.filter(n=>n.isSkinnedMesh)).map(n=>({target:n,index:a.index,weight:a.weight/100}))});return t[(i.presetName||i.name).toUpperCase()]={name:i.name,binds:s},t},{})}_fixBoundingBox(){let e=this.bones;if(!e.hips)return;let t=new THREE.Vector3,i=e.hips.getWorldPosition(t).clone();this.model.traverse(s=>{let a=s;if(a.isSkinnedMesh){let r=a.getWorldPosition(t).sub(i).multiplyScalar(-1),n=r.clone().sub(a.geometry.boundingSphere.center).length()+a.geometry.boundingSphere.radius;a.geometry.boundingSphere.center.copy(r),a.geometry.boundingSphere.radius=n,a.geometry.boundingBox.min.set(r.x-n,r.y-n,r.z-n),a.geometry.boundingBox.max.set(r.x+n,r.y+n,r.z+n)}})}tick(e){this.mixer.update(e);for(let t of Object.values(this.modules))t.update(e)}setModule(e,t){this.removeModule(e),this.modules[e]=t}removeModule(e){let t=this.modules[e];t&&t.dispose&&t.dispose(),delete this.modules[e]}dispose(){for(let e of Object.keys(this.modules))this.removeModule(e);this.model.traverse(e=>{let t=e;t.isMesh&&(t.geometry.dispose(),t.material.map?.dispose()),e.skeleton&&e.skeleton.dispose()})}get lookAtTarget(){let e=this.modules.lookat;return e?e.target:null}set lookAtTarget(e){let t=this.modules.lookat;t&&(t.target=e)}setBlendShapeWeight(e,t){this._blendShapeUtil.setBlendShapeWeight(e,t)}getBlendShapeWeight(e){return this._blendShapeUtil.getBlendShapeWeight(e)}resetBlendShape(){this._blendShapeUtil.resetBlendShape()}startBlink(e){this._blendShapeUtil.startBlink(e)}stopBlink(){this._blendShapeUtil.stopBlink()}getPose(e){let t={bones:Object.keys(this.bones).map(i=>({name:i,q:this.bones[i].quaternion.toArray()}))};return e&&(t.blendShape=Object.keys(this.blendShapes).map(i=>({name:i,value:this.getBlendShapeWeight(i)}))),t}setPose(e){if(e.bones)for(let t of e.bones)this.bones[t.name]&&this.bones[t.name].quaternion.fromArray(t.q);if(e.blendShape)for(let t of e.blendShape)this.setBlendShapeWeight(t.name,t.value)}restPose(){for(let e of Object.values(this.bones))e.quaternion.set(0,0,0,1)}setFirstPerson(e){this._firstPersonMeshUtil&&this._firstPersonMeshUtil.setFirstPerson(e)}};var D=class{constructor(e){this.collisionGroup=2;this.enable=!1;this.binds=[];this.fixedBinds=[];this.bodies=[];this.constraints=[];this._tmpQ0=new THREE.Quaternion;this._tmpV0=new THREE.Vector3;this._tmpV1=new THREE.Vector3;this.world=null;this.internalWorld=!1;this.springBoneSystem=this._springBoneSystem(),this._init(e)}_init(e){if(!e.vrm.secondaryAnimation)return;let t=e.nodes,i=e.vrm.secondaryAnimation,s=0,a=.9;(i.colliderGroups||[]).forEach((r,n)=>{let l=t[r.node];for(let p of r.colliders){let h=new CANNON.Body({mass:0,collisionFilterGroup:1<<this.collisionGroup+n+1,collisionFilterMask:-1});h.addShape(new CANNON.Sphere(p.radius*a),p.offset),this.bodies.push(h),this.fixedBinds.push([l,h]),s|=h.collisionFilterGroup}});for(let r of i.boneGroups||[]){let n=new CANNON.Vec3().copy(r.gravityDir||{x:0,y:-1,z:0}).scale(r.gravityPower||0),l=r.hitRadius||.05,p=~(this.collisionGroup|s);for(let h of r.colliderGroups||[])p|=1<<this.collisionGroup+h+1;for(let h of r.bones){let d=new CANNON.Body({mass:0,collisionFilterGroup:0,collisionFilterMask:0});d.position.copy(t[h].parent.getWorldPosition(this._tmpV0)),this.bodies.push(d),this.fixedBinds.push([t[h].parent,d]);let E=(g,b)=>{let w=b.getWorldPosition(this._tmpV0),m=w.clone(),c=b.children.length+1;b.children.length>0?b.children.forEach(y=>{w.add(y.getWorldPosition(this._tmpV1))}):(w.add(b.parent.getWorldPosition(this._tmpV1).sub(w).normalize().multiplyScalar(-.1).add(w)),c=2),w.multiplyScalar(1/c);let u=new CANNON.Body({mass:.5,linearDamping:Math.max(r.dragForce||0,1e-4),angularDamping:Math.max(r.dragForce||0,1e-4),collisionFilterGroup:this.collisionGroup,collisionFilterMask:p,position:new CANNON.Vec3().copy(w)});u.addShape(new CANNON.Sphere(l)),this.bodies.push(u);let _=new CANNON.Vec3().copy(this._tmpV1.copy(m).sub(w)),N=new CANNON.Vec3().copy(m.sub(g.position)),f=new CANNON.PointToPointConstraint(u,_,g,N);this.constraints.push(f),this.binds.push([b,u]),this.springBoneSystem.objects.push({body:u,parentBody:g,force:n,boneGroup:r,size:l}),b.children.forEach(y=>y.isBone&&E(u,y))};E(d,t[h])}}}_springBoneSystem(){let e=new CANNON.Quaternion,t=new CANNON.Quaternion,i=new CANNON.Vec3;return{world:null,objects:[],update(){let s=this.world.gravity,a=this.world.dt,r=.1;for(let n of this.objects){let l=n.body,p=n.parentBody,h=l.force,d=l.mass,E=n.force;h.x+=d*(-s.x+E.x),h.y+=d*(-s.y+E.y),h.z+=d*(-s.z+E.z);let g=l.angularVelocity.length();g>r&&l.angularVelocity.scale(r/g,l.angularVelocity);let b=n.boneGroup.stiffiness,w=n.size*n.size*d*1600,m=l.quaternion.mult(p.quaternion.inverse(e),t),[c,u]=m.toAxisAngle(i);u=u-Math.PI*2*Math.floor((u+Math.PI)/(Math.PI*2));let _=u*b;Math.abs(_)>Math.abs(u/a/a*25e-5)&&(_=u/a/a*25e-5);let N=c.scale(-_*w,c);l.torque.vadd(N,l.torque)}}}}attach(e){this.detach(),this.internalWorld=e==null,this.world=e||new CANNON.World,this.springBoneSystem.world=this.world,this.world.subsystems.push(this.springBoneSystem),this.bodies.forEach(t=>this.world.addBody(t)),this.constraints.forEach(t=>this.world.addConstraint(t)),this.reset(),this.enable=!0,this.world.bodies.forEach(t=>{t.collisionFilterGroup==1&&t.collisionFilterMask==1&&(t.collisionFilterMask=-1)})}detach(){!this.world||(this.world.subsystems=this.world.subsystems.filter(e=>e!=this.springBoneSystem),this.world.constraints=this.world.constraints.filter(e=>!this.constraints.includes(e)),this.world.bodies=this.world.bodies.filter(e=>!this.bodies.includes(e)),this.world=null,this.enable=!1)}reset(){this.fixedBinds.forEach(([e,t])=>{e.updateWorldMatrix(!0,!1),t.position.copy(e.getWorldPosition(this._tmpV0)),t.quaternion.copy(e.parent.getWorldQuaternion(this._tmpQ0))}),this.binds.forEach(([e,t])=>{e.updateWorldMatrix(!0,!1),t.position.copy(e.getWorldPosition(this._tmpV0)),t.quaternion.copy(e.getWorldQuaternion(this._tmpQ0))})}update(e){!this.enable||(this.fixedBinds.forEach(([t,i])=>{i.position.copy(t.getWorldPosition(this._tmpV0)),i.quaternion.copy(t.getWorldQuaternion(this._tmpQ0))}),this.internalWorld&&this.world.step(1/60,e),this.binds.forEach(([t,i])=>{t.quaternion.copy(i.quaternion).premultiply(t.parent.getWorldQuaternion(this._tmpQ0).invert())}))}dispose(){this.detach()}};var W=class{constructor(e,t,i){this.quaternion=new THREE.Quaternion;this.worldMatrix=new THREE.Matrix4;this.worldPosition=new THREE.Vector3;this.position=e,this.constraint=t,this.userData=i}},U=class{constructor(){this.iterationLimit=50;this.thresholdSq=1e-4;this._iv=new THREE.Vector3(1,1,1);this._tmpV0=new THREE.Vector3;this._tmpV1=new THREE.Vector3;this._tmpV2=new THREE.Vector3;this._tmpQ0=new THREE.Quaternion;this._tmpQ1=new THREE.Quaternion}_updateChain(e,t){for(let i of e)i.worldMatrix.compose(i.position,i.quaternion,this._iv).premultiply(t),i.worldPosition.setFromMatrixPosition(i.worldMatrix),t=i.worldMatrix}solve(e,t,i){this._updateChain(e,i);let s=e[e.length-1].worldPosition,a=s.distanceToSquared(t),r=this._tmpV2,n=this._tmpV1,l=this._tmpQ1;for(let p=0;p<this.iterationLimit&&!(s.distanceToSquared(t)<this.thresholdSq);p++){let h=this._tmpV0.copy(t);for(let d=e.length-2;d>=0;d--){let E=e[d],g=e[d+1].position;E.worldMatrix.decompose(this._tmpV1,this._tmpQ0,this._tmpV2),r.copy(h).sub(this._tmpV1).applyQuaternion(l.copy(this._tmpQ0).invert()).normalize(),n.copy(g).normalize(),l.setFromUnitVectors(n,r),E.quaternion.multiply(l);let b=n.copy(g).applyQuaternion(this._tmpQ0.multiply(l));E.constraint&&(l.copy(E.quaternion).invert(),E.constraint.apply(E)&&(l.premultiply(E.quaternion),b.copy(g).applyQuaternion(this._tmpQ0.multiply(l)))),h.sub(b)}this._updateChain(e,i)}return s.distanceToSquared(t)<a}};var Q=class{constructor(){this.boneMapping=[{bone:"hips",nodeNames:["\u30BB\u30F3\u30BF\u30FC","center"]},{bone:"spine",nodeNames:["\u4E0A\u534A\u8EAB","upper body"]},{bone:"chest",nodeNames:["\u4E0A\u534A\u8EAB2","upper body2"]},{bone:"neck",nodeNames:["\u9996","neck"]},{bone:"head",nodeNames:["\u982D","head"]},{bone:"leftShoulder",nodeNames:["\u5DE6\u80A9","shoulder_L"]},{bone:"leftUpperArm",nodeNames:["\u5DE6\u8155","arm_L"]},{bone:"leftLowerArm",nodeNames:["\u5DE6\u3072\u3058","elbow_L"]},{bone:"leftHand",nodeNames:["\u5DE6\u624B\u9996","wrist_L"]},{bone:"rightShoulder",nodeNames:["\u53F3\u80A9","shoulder_R"]},{bone:"rightUpperArm",nodeNames:["\u53F3\u8155","arm_R"]},{bone:"rightLowerArm",nodeNames:["\u53F3\u3072\u3058","elbow_R"]},{bone:"rightHand",nodeNames:["\u53F3\u624B\u9996","wrist_R"]},{bone:"leftUpperLeg",nodeNames:["\u5DE6\u8DB3","leg_L"]},{bone:"leftLowerLeg",nodeNames:["\u5DE6\u3072\u3056","knee_L"]},{bone:"leftFoot",nodeNames:["\u5DE6\u8DB3\u9996","ankle_L"]},{bone:"leftToes",nodeNames:["\u5DE6\u3064\u307E\u5148","L toe"]},{bone:"rightUpperLeg",nodeNames:["\u53F3\u8DB3","leg_R"]},{bone:"rightLowerLeg",nodeNames:["\u53F3\u3072\u3056","knee_R"]},{bone:"rightFoot",nodeNames:["\u53F3\u8DB3\u9996","ankle_R"]},{bone:"rightToes",nodeNames:["\u53F3\u3064\u307E\u5148","R toe"]},{bone:"leftEye",nodeNames:["\u5DE6\u76EE","eye_L"]},{bone:"rightEye",nodeNames:["\u53F3\u76EE","eye_R"]},{bone:"leftThumbProximal",nodeNames:["\u5DE6\u89AA\u6307\uFF10","thumb0_L"]},{bone:"leftThumbIntermediate",nodeNames:["\u5DE6\u89AA\u6307\uFF11","thumb1_L"]},{bone:"leftThumbDistal",nodeNames:["\u5DE6\u89AA\u6307\uFF12","thumb2_L"]},{bone:"leftIndexProximal",nodeNames:["\u5DE6\u4EBA\u6307\uFF11","fore1_L"]},{bone:"leftIndexIntermediate",nodeNames:["\u5DE6\u4EBA\u6307\uFF12","fore2_L"]},{bone:"leftIndexDistal",nodeNames:["\u5DE6\u4EBA\u6307\uFF13","fore3_L"]},{bone:"leftMiddleProximal",nodeNames:["\u5DE6\u4E2D\u6307\uFF11","middle1_L"]},{bone:"leftMiddleIntermediate",nodeNames:["\u5DE6\u4E2D\u6307\uFF12","middle2_L"]},{bone:"leftMiddleDistal",nodeNames:["\u5DE6\u4E2D\u6307\uFF13","middle3_L"]},{bone:"leftRingProximal",nodeNames:["\u5DE6\u85AC\u6307\uFF11","third1_L"]},{bone:"leftRingIntermediate",nodeNames:["\u5DE6\u85AC\u6307\uFF12","third2_L"]},{bone:"leftRingDistal",nodeNames:["\u5DE6\u85AC\u6307\uFF13","third3_L"]},{bone:"leftLittleProximal",nodeNames:["\u5DE6\u5C0F\u6307\uFF11","little1_L"]},{bone:"leftLittleIntermediate",nodeNames:["\u5DE6\u5C0F\u6307\uFF12","little2_L"]},{bone:"leftLittleDistal",nodeNames:["\u5DE6\u5C0F\u6307\uFF13","little3_L"]},{bone:"rightThumbProximal",nodeNames:["\u53F3\u89AA\u6307\uFF10","thumb0_R"]},{bone:"rightThumbIntermediate",nodeNames:["\u53F3\u89AA\u6307\uFF11","thumb1_R"]},{bone:"rightThumbDistal",nodeNames:["\u53F3\u89AA\u6307\uFF12","thumb2_R"]},{bone:"rightIndexProximal",nodeNames:["\u53F3\u4EBA\u6307\uFF11","fore1_R"]},{bone:"rightIndexIntermediate",nodeNames:["\u53F3\u4EBA\u6307\uFF12","fore2_R"]},{bone:"rightIndexDistal",nodeNames:["\u53F3\u4EBA\u6307\uFF13","fore3_R"]},{bone:"rightMiddleProximal",nodeNames:["\u53F3\u4E2D\u6307\uFF11","middle1_R"]},{bone:"rightMiddleIntermediate",nodeNames:["\u53F3\u4E2D\u6307\uFF12","middle2_R"]},{bone:"rightMiddleDistal",nodeNames:["\u53F3\u4E2D\u6307\uFF13","middle3_R"]},{bone:"rightRingProximal",nodeNames:["\u53F3\u85AC\u6307\uFF11","third1_R"]},{bone:"rightRingIntermediate",nodeNames:["\u53F3\u85AC\u6307\uFF12","third2_R"]},{bone:"rightRingDistal",nodeNames:["\u53F3\u85AC\u6307\uFF13","third3_R"]},{bone:"rightLittleProximal",nodeNames:["\u53F3\u5C0F\u6307\uFF11","little1_R"]},{bone:"rightLittleIntermediate",nodeNames:["\u53F3\u5C0F\u6307\uFF12","little2_R"]},{bone:"rightLittleDistal",nodeNames:["\u53F3\u5C0F\u6307\uFF13","little3_R"]}];this.blendShapeMap={A:"\u3042",I:"\u3044",U:"\u3046",E:"\u3048",O:"\u304A",BLINK:"\u307E\u3070\u305F\u304D"};this.rotationOffsets={leftUpperArm:-38*THREE.MathUtils.DEG2RAD,rightUpperArm:38*THREE.MathUtils.DEG2RAD};this.ikConfigs=[{target:"\u5DE6\u8DB3\uFF29\uFF2B",bones:["leftFoot","leftLowerLeg","leftUpperLeg"]},{target:"\u53F3\u8DB3\uFF29\uFF2B",bones:["rightFoot","rightLowerLeg","rightUpperLeg"]},{target:"\u5DE6\u3064\u307E\u5148\uFF29\uFF2B",parent:0,bones:["leftToes","leftFoot"]},{target:"\u53F3\u3064\u307E\u5148\uFF29\uFF2B",parent:1,bones:["rightToes","rightFoot"]}];this.boneConstraints={leftLowerLeg:{min:new THREE.Vector3(-175*Math.PI/180,0,0),max:new THREE.Vector3(0,0,0)},rightLowerLeg:{min:new THREE.Vector3(-175*Math.PI/180,0,0),max:new THREE.Vector3(0,0,0)},leftUpperLeg:{min:new THREE.Vector3(-Math.PI/2,-Math.PI/2,-Math.PI/2),max:new THREE.Vector3(Math.PI,Math.PI/2,Math.PI/2)},rightUpperLeg:{min:new THREE.Vector3(-Math.PI/2,-Math.PI/2,-Math.PI/2),max:new THREE.Vector3(Math.PI,Math.PI/2,Math.PI/2)}}}async load(e,t,i){let{MMDLoader:s}=await import("https://threejs.org/examples/jsm/loaders/MMDLoader.js"),{CCDIKSolver:a}=await import("https://threejs.org/examples/jsm/animation/CCDIKSolver.js"),r=new s,n={};for(let m of this.boneMapping){let c=t.bones[m.bone];if(c)for(let u of m.nodeNames)n[u]=c.name}let l={},p={};for(let[m,c]of Object.entries(this.rotationOffsets)){let u=t.bones[m];u&&(l[u.name]=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),c),u.traverse(_=>{p[_.name]=[Math.cos(c),Math.sin(c)]}))}let h={};for(let[m,c]of Object.entries(this.blendShapeMap))t.blendShapes[m]&&(h[c]=m);t.model.morphTargetDictionary=h;let d=.08,E=(m,c)=>{[m[0],m[2]]=[m[0]*c[0]-m[2]*c[1],m[0]*c[1]+m[2]*c[0]]},g=(m,c)=>{[m[0],m[1]]=[m[0]*c[0]-m[1]*c[1],m[0]*c[1]+m[1]*c[0]]},b=new THREE.Quaternion,w=new THREE.Quaternion;return await new Promise((m,c)=>{r.loadVMD(e,async u=>{let _=u.motions.filter(f=>f.boneName=="\u4E0B\u534A\u8EAB");if(_.length){_.sort((y,v)=>y.frameNum-v.frameNum);let f=(y,v)=>{y.sort((R,A)=>R.frameNum-A.frameNum);let M=0;for(let R of y){for(;M<_.length-1&&R.frameNum>_[M].frameNum;)M++;let A=w.fromArray(_[M].rotation);if(M>0&&R.frameNum<_[M].frameNum){let x=(R.frameNum-_[M-1].frameNum)/(_[M].frameNum-_[M-1].frameNum);A.slerp(b.fromArray(_[M-1].rotation),1-x)}v&&A.invert(),R.rotation=b.fromArray(R.rotation).multiply(A).toArray()}};f(u.motions.filter(y=>y.boneName=="\u30BB\u30F3\u30BF\u30FC"),!1),f(u.motions.filter(y=>y.boneName=="\u4E0A\u534A\u8EAB"),!0),_.forEach(y=>y.rotation=[0,0,0,1])}for(let f of u.motions){n[f.boneName]&&(f.boneName=n[f.boneName]);let y=l[f.boneName];y&&(f.rotation=b.fromArray(f.rotation).premultiply(y).toArray()),f.position[0]*=d,f.position[1]*=d,f.position[2]*=d,E(f.position,[-1,0]),E(f.rotation,[-1,0]);let v=p[f.boneName];v&&(g(f.position,v),g(f.rotation,v))}if(i.enableIK){let f=t.model.skeleton.bones,y=M=>{let R=f.findIndex(T=>T.name==M.target);if(R>=0)return R;let A=M.parent!=null?f[y(this.ikConfigs[M.parent])]:t.model,x=new THREE.Bone;x.name=M.target,f.push(x),A.add(x),A.updateMatrixWorld();let P=t.bones[M.bones[0]].getWorldPosition(new THREE.Vector3);return x.position.copy(P.applyMatrix4(A.matrixWorld.clone().invert())),f.length-1},v=[];for(let M of this.ikConfigs){if(u.motions.find(T=>T.boneName==M.target)==null)continue;let R=T=>f.findIndex(H=>H==t.bones[T]),A=R(M.bones[0]);if(A<0)continue;let x=[];M.bones.slice(1).forEach(T=>{let H=R(T);if(H>=0){let V={index:H},B=this.boneConstraints[T];B&&(V.rotationMax=B.max,V.rotationMin=B.min),x.push(V)}});let P={target:y(M),effector:A,links:x,maxAngle:1,iteration:4};v.push(P)}if(v.length>0){console.log(v);let M=new a(t.model,v);t.setModule("MMDIK",{update:R=>M.update()})}}let N=r.animationBuilder.build(u,t.model);N.tracks.forEach(f=>{let y=f.name.match(/.morphTargetInfluences\[(\w+)\]/);if(y){let v=t.blendShapes[y[1]];v&&v.binds.length>0&&(f.name=v.binds[0].target.uuid+".morphTargetInfluences["+v.binds[0].index+"]")}}),m(N)},()=>{},c)})}};var j=class{async load(e,t,i){let{BVHLoader:s}=await import("https://threejs.org/examples/jsm/loaders/BVHLoader.js");return await new Promise((a,r)=>{new s().load(e,n=>{i.convertBone&&this.fixTrackName(n.clip,t),n.clip.tracks=n.clip.tracks.filter(l=>!l.name.match(/position/)||l.name.match(t.bones.hips.name)),a(n.clip)})})}convertBoneName(e){return e=e.replace("Spin1","Spin"),e=e.replace("Chest1","Chest"),e=e.replace("Chest2","UpperChest"),e=e.replace("UpLeg","UpperLeg"),e=e.replace("LeftLeg","LeftLowerLeg"),e=e.replace("RightLeg","RightLowerLeg"),e=e.replace("ForeArm","UpperArm"),e=e.replace("LeftArm","LeftLowerArm"),e=e.replace("RightArm","RightLowerArm"),e=e.replace("Collar","Shoulder"),e=e.replace("Elbow","LowerArm"),e=e.replace("Wrist","Hand"),e=e.replace("LeftHip","LeftUpperLeg"),e=e.replace("RightHip","RightUpperLeg"),e=e.replace("Knee","LowerLeg"),e=e.replace("Ankle","Foot"),e.charAt(0).toLowerCase()+e.slice(1)}fixTrackName(e,t){e.tracks.forEach(i=>{i.name=i.name.replace(/bones\[(\w+)\]/,(s,a)=>{let r=t.bones[this.convertBoneName(a)];return"bones["+(r!=null?r.name:"NODE_NOT_FOUND")+"]"}),i.name=i.name.replace("ToeBase","Foot"),i.name.match(/quaternion/)&&(i.values=i.values.map((s,a)=>a%2==0?-s:s)),i.name.match(/position/)&&(i.values=i.values.map((s,a)=>(a%3==1?s:-s)*.09))}),e.tracks=e.tracks.filter(i=>!i.name.match(/NODE_NOT_FOUND/))}};AFRAME.registerComponent("vrm",{schema:{src:{default:""},firstPerson:{default:!1},blink:{default:!0},blinkInterval:{default:5},lookAt:{type:"selector"},enablePhysics:{default:!1}},init(){this.avatar=null},update(o){this.data.src!==o.src&&(this.remove(),this._loadAvatar()),this._updateAvatar()},tick(o,e){if(!this.avatar){this.pause();return}this.avatar.tick(e/1e3)},remove(){this.avatar&&(this.el.removeObject3D("avatar"),this.avatar.dispose())},async _loadAvatar(){let o=this.el,e=this.data.src;if(!!e)try{let t=[];globalThis.CANNON&&t.push({name:"physics",instantiate:(s,a)=>new D(a)});let i=await L.load(e,t);if(e!=this.data.src){i.dispose();return}this.avatar=i,o.setObject3D("avatar",i.model),this._updateAvatar(),this.play(),o.emit("model-loaded",{format:"vrm",model:i.model,avatar:i},!1)}catch(t){o.emit("model-error",{format:"vrm",src:e,cause:t},!1)}},_updateAvatar(){if(!this.avatar)return;let o=this.data;this.avatar.setFirstPerson(o.firstPerson),o.lookAt?o.lookAt.tagName=="A-CAMERA"?this.avatar.lookAtTarget=this.el.sceneEl.camera:this.avatar.lookAtTarget=o.lookAt.object3D:this.avatar.lookAtTarget=null,o.blink?this.avatar.startBlink(o.blinkInterval):this.avatar.stopBlink();let e=this.avatar.modules.physics;if(e){if(o.enablePhysics&&e.world==null){let t=this.el.sceneEl.systems.physics;e.attach(t&&t.driver&&t.driver.world)}e.enable=o.enablePhysics}}});AFRAME.registerComponent("vrm-bvh",{schema:{src:{default:""},format:{default:""},loop:{default:!0},enableIK:{default:!0},convertBone:{default:!0}},init(){this.avatar=null,this.el.components.vrm&&this.el.components.vrm.avatar&&(this.avatar=this.el.components.vrm.avatar),this.onVrmLoaded=o=>{this.avatar=o.detail.avatar,this.data.src!=""?this._loadClip(this.data.src):this.avatar.animations.length||this.playTestMotion()},this.el.addEventListener("model-loaded",this.onVrmLoaded)},update(o){o.src!=this.data.src&&this.avatar&&this._loadClip(this.data.src)},async _loadClip(o){if(this.stopAnimation(),this.avatar.restPose(),o==="")return;let e=this.data.loop?THREE.LoopRepeat:THREE.LoopOnce,s=await((this.data.format||(o.toLowerCase().endsWith(".bvh")?"bvh":""))=="bvh"?new j:new Q).load(o,this.avatar,this.data);!this.avatar||(this.clip=s,this.avatar.mixer.setTime(0),this.animation=this.avatar.mixer.clipAction(s).setLoop(e).setEffectiveWeight(1).play())},stopAnimation(){this.animation&&(this.animation.stop(),this.avatar.mixer.uncacheClip(this.clip),this.avatar.removeModule("MMDIK"))},playTestMotion(){let o=(i,s,a)=>new THREE.Quaternion().setFromEuler(new THREE.Euler(i*Math.PI/180,s*Math.PI/180,a*Math.PI/180)),e={leftUpperArm:{keys:[{rot:o(0,0,65),time:0},{rot:o(0,0,63),time:1},{rot:o(0,0,65),time:2}]},rightUpperArm:{keys:[{rot:o(0,0,-65),time:0},{rot:o(0,0,-60),time:1},{rot:o(0,0,-65),time:2}]},spine:{keys:[{rot:o(0,2,0),time:0},{rot:o(2,0,-2),time:1},{rot:o(2,-2,0),time:2},{rot:o(0,0,2),time:3},{rot:o(0,2,0),time:4}]}},t=THREE.AnimationClip.parseAnimation({name:"testAnimation",hierarchy:Object.values(e)},Object.keys(e).map(i=>this.avatar.bones[i]||{name:i}));this.clip=t,this.animation=this.avatar.mixer.clipAction(t).setEffectiveWeight(1).play()},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this.stopAnimation(),this.avatar=null}});AFRAME.registerComponent("vrm-skeleton",{schema:{physicsOffset:{type:"vec3",default:{x:0,y:0,z:0}}},init(){this.physicsBodies=[],this.sceneObj=this.el.sceneEl.object3D,this.el.components.vrm&&this.el.components.vrm.avatar&&this._onAvatarUpdated(this.el.components.vrm.avatar),this.onVrmLoaded=o=>this._onAvatarUpdated(o.detail.avatar),this.el.addEventListener("model-loaded",this.onVrmLoaded)},_onAvatarUpdated(o){this.helper&&this.sceneObj.remove(this.helper),this.helper=new THREE.SkeletonHelper(o.model),this.sceneObj.add(this.helper),this._updatePhysicsBody(o)},_updatePhysicsBody(o){this._clearPhysicsBody();let e=o.modules.physics;if(!e||!e.world)return;let t=new THREE.SphereGeometry(1,6,3),i=new THREE.MeshBasicMaterial({color:new THREE.Color("red"),wireframe:!0,depthTest:!1});e.bodies.forEach(s=>{let a=new THREE.Group;s.shapes.forEach((r,n)=>{let l=new THREE.Mesh(t,i);l.position.copy(s.shapeOffsets[n]),l.scale.multiplyScalar(r.boundingSphereRadius||.01),a.add(l)}),this.sceneObj.add(a),this.physicsBodies.push([s,a])})},_clearPhysicsBody(){this.physicsBodies.forEach(([o,e])=>e.parent.remove(e)),this.physicsBodies=[]},tick(){this.physicsBodies.forEach(([o,e])=>{e.position.copy(o.position).add(this.data.physicsOffset),e.quaternion.copy(o.quaternion)})},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this._clearPhysicsBody(),this.helper&&this.sceneObj.remove(this.helper)}});AFRAME.registerComponent("vrm-poser",{schema:{color:{default:"#00ff00"},enableConstraints:{default:!0}},init(){this.binds=[],this._tmpV0=new THREE.Vector3,this._tmpV1=new THREE.Vector3,this._tmpQ0=new THREE.Quaternion,this._tmpQ1=new THREE.Quaternion,this._tmpM0=new THREE.Matrix4,this.el.components.vrm&&this.el.components.vrm.avatar&&this._onAvatarUpdated(this.el.components.vrm.avatar),this.onVrmLoaded=o=>this._onAvatarUpdated(o.detail.avatar),this.el.addEventListener("model-loaded",this.onVrmLoaded)},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this._removeHandles()},getPoseData(o){if(!!this.avatar)return this.avatar.getPose(o)},setPoseData(o){!this.avatar||(this.avatar.setPose(o),this._updateHandlePosition())},_onAvatarUpdated(o){this._removeHandles(),this.avatar=o;let e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial({color:new THREE.Color(this.data.color),transparent:!0,opacity:.4,depthTest:!1}),i=this._tmpV0,s=this._tmpV1,a=this._tmpM0,r=this._tmpQ0,n=o.bones.hips,l={};for(let p of Object.keys(o.bones)){let h=o.bones[p],d=h==n,E=new THREE.Mesh(e,t),g=document.createElement("a-entity");g.classList.add("collidable"),g.setAttribute("xy-drag-control",{}),g.setObject3D("handle",E);let b=g.object3D,w=h.children.reduce((c,u)=>Math.min(c,u.position.length()),h.position.length());b.scale.multiplyScalar(Math.max(Math.min(w/2,.05),.01)),l[h.uuid]=p,g.addEventListener("mousedown",c=>{this.el.emit("vrm-poser-select",{name:p,node:h})});let m=h.parent;for(;!l[m.uuid]&&m.parent&&m.parent.isBone;)m=m.parent;g.addEventListener("xy-drag",c=>{if(d){let u=b.parent.worldToLocal(h.getWorldPosition(i)).sub(b.position);o.model.position.sub(u)}m.updateMatrixWorld(!1),b.updateMatrixWorld(!1),a.getInverse(m.matrixWorld).multiply(b.matrixWorld).decompose(s,r,i),h.quaternion.copy(this._applyConstraintQ(p,r)),r.setFromUnitVectors(i.copy(h.position).normalize(),s.normalize()),m.children.length==1&&(m.quaternion.multiply(r),this._applyConstraintQ(l[m.uuid],m.quaternion)),this._updateHandlePosition(d?null:h)}),g.addEventListener("xy-dragend",c=>{this._updateHandlePosition(),console.log(m.name,p)}),this.el.appendChild(g),this.binds.push([h,b])}this._updateHandlePosition()},_applyConstraintQ(o,e){if(!this.data.enableConstraints)return e;let t=this._tmpQ1,i=this._tmpV0,s=this.avatar.boneConstraints[o];if(s&&s.type=="ball"){let a=2*Math.acos(e.w);if(s.twistAxis){let r=a*Math.acos(e.w)*i.copy(e).normalize().dot(s.twistAxis);if(r=this._normalizeAngle(r),Math.abs(r)>s.twistLimit){let n=r<0?r+s.twistLimit:r-s.twistLimit;e.multiply(t.setFromAxisAngle(s.twistAxis,-n)),a=2*Math.acos(e.w)}}Math.abs(this._normalizeAngle(a))>s.limit&&e.setFromAxisAngle(i.copy(e).normalize(),s.limit)}else if(s&&s.type=="hinge"){let a=(s.min+s.max)/2,r=2*Math.acos(e.w)*i.copy(e).normalize().dot(s.axis);r=THREE.MathUtils.clamp(this._normalizeAngle(r-a),s.min-a,s.max-a),e.setFromAxisAngle(s.axis,r+a)}return e},_normalizeAngle(o){return o-Math.PI*2*Math.floor((o+Math.PI)/(Math.PI*2))},_removeHandles(){this.binds.forEach(([o,e])=>{this.el.removeChild(e.el);let t=e.el.getObject3D("handle");t&&(t.material.dispose(),t.geometry.dispose()),e.el.destroy()}),this.binds=[]},_updateHandlePosition(o){let e=this._tmpV0,t=this.el.object3D;t.updateMatrixWorld(!1);let i=t.matrixWorld.clone().invert();this.binds.forEach(([s,a])=>{let r=s==o?e:a.position;s.updateMatrixWorld(!1),a.matrix.copy(s.matrixWorld).premultiply(i).decompose(r,a.quaternion,e)})}});AFRAME.registerComponent("vrm-mimic",{schema:{leftHandTarget:{type:"selector",default:""},leftHandOffsetPosition:{type:"vec3"},leftHandOffsetRotation:{type:"vec3",default:{x:0,y:-Math.PI/2,z:0}},rightHandTarget:{type:"selector",default:""},rightHandOffsetPosition:{type:"vec3"},rightHandOffsetRotation:{type:"vec3",default:{x:0,y:Math.PI/2,z:0}},leftLegTarget:{type:"selector",default:""},rightLegTarget:{type:"selector",default:""},headTarget:{type:"selector",default:""},avatarOffset:{type:"vec3",default:{x:0,y:0,z:0}}},init(){this._tmpV0=new THREE.Vector3,this._tmpV1=new THREE.Vector3,this._tmpQ0=new THREE.Quaternion,this._tmpQ1=new THREE.Quaternion,this._tmpM0=new THREE.Matrix4,this.targetEls=[],this.el.components.vrm&&this.el.components.vrm.avatar&&this._onAvatarUpdated(this.el.components.vrm.avatar),this.onVrmLoaded=o=>this._onAvatarUpdated(o.detail.avatar),this.el.addEventListener("model-loaded",this.onVrmLoaded)},update(){this.data.headTarget?this.data.headTarget.tagName=="A-CAMERA"?this.headTarget=this.el.sceneEl.camera:this.headTarget=this.data.headTarget.object3D:this.headTarget=null,this.rightHandOffset=new THREE.Matrix4().compose(this.data.rightHandOffsetPosition,new THREE.Quaternion().setFromEuler(new THREE.Euler().setFromVector3(this.data.rightHandOffsetRotation)),new THREE.Vector3(1,1,1)),this.leftHandOffset=new THREE.Matrix4().compose(this.data.leftHandOffsetPosition,new THREE.Quaternion().setFromEuler(new THREE.Euler().setFromVector3(this.data.leftHandOffsetRotation)),new THREE.Vector3(1,1,1))},_onAvatarUpdated(o){this.avatar=o;for(let e of this.targetEls)this.el.removeChild(e);this.targetEls=[],this.update(),this.startAvatarIK_simpleIK(o)},startAvatarIK_simpleIK(o){let e=new U;this.qbinds=[];let t=(i,s,a)=>{s==null&&(s=document.createElement("a-box"),s.classList.add("collidable"),s.setAttribute("xy-drag-control",{}),s.setAttribute("geometry",{width:.05,depth:.05,height:.05}),s.setAttribute("material",{color:"blue",depthTest:!1,transparent:!0,opacity:.4}),this.el.appendChild(s),this.targetEls.push(s));let r=(p,h)=>h.worldToLocal(p.getWorldPosition(new THREE.Vector3));i=i.filter(p=>o.bones[p]);let n=i.map(p=>o.bones[p]),l=n.map((p,h)=>{let d=h==0?p.position:r(p,n[h-1]),E=o.boneConstraints[i[h]],g=E?{apply:b=>this._applyConstraintQ(E,b.quaternion)}:null;return new W(d,g,p)});return this.qbinds.push([n[n.length-1],s.object3D,a]),{root:n[0],ikbones:l,bones:n,target:s.object3D}};this.chains=[t(["leftUpperArm","leftLowerArm","leftHand"],this.data.leftHandTarget,this.leftHandOffset),t(["rightUpperArm","rightLowerArm","rightHand"],this.data.rightHandTarget,this.rightHandOffset),t(["leftUpperLeg","leftLowerLeg","leftFoot"],this.data.leftLegTarget),t(["rightUpperLeg","rightLowerLeg","rightFoot"],this.data.rightLegTarget)],this.simpleIK=e},_applyConstraintQ(o,e){let t=this._tmpQ1,i=this._tmpV0,s=!1;if(o&&o.type=="ball"){let a=2*Math.acos(e.w);if(o.twistAxis){let r=a*Math.acos(e.w)*i.copy(e).normalize().dot(o.twistAxis);if(r=this._normalizeAngle(r),Math.abs(r)>o.twistLimit){let n=r<0?r+o.twistLimit:r-o.twistLimit;e.multiply(t.setFromAxisAngle(o.twistAxis,-n)),a=2*Math.acos(e.w),s=!0}}Math.abs(this._normalizeAngle(a))>o.limit&&(e.setFromAxisAngle(i.copy(e).normalize(),o.limit),s=!0)}else if(o&&o.type=="hinge"){let a=(o.min+o.max)/2,r=i.copy(e).normalize().dot(o.axis),n=2*Math.acos(e.w)*r;n=THREE.MathUtils.clamp(this._normalizeAngle(n-a),o.min-a,o.max-a),e.setFromAxisAngle(o.axis,n+a),s=!0}return s},_normalizeAngle(o){return o-Math.PI*2*Math.floor((o+Math.PI)/(Math.PI*2))},tick(o,e){if(!!this.avatar){if(this.headTarget){let t=this._tmpV0,i=this._tmpQ0;this.headTarget.matrixWorld.decompose(t,i,this._tmpV1),t.y=0,this.avatar.model.position.copy(t.add(this.data.avatarOffset));let s=this.avatar.firstPersonBone;if(s){let a=this._tmpQ1.setFromRotationMatrix(s.parent.matrixWorld).invert();s.quaternion.copy(i.premultiply(a))}}if(this.simpleIK){let t=this.el.object3D.matrixWorld.clone().invert();for(let i of this.chains){let s=i.root.parent.matrixWorld.clone().premultiply(t);this.simpleIK.solve(i.ikbones,i.target.position,s),i.ikbones.forEach((a,r)=>{if(r==i.ikbones.length-1)return;let n=a.userData.quaternion.angleTo(a.quaternion);n>.2?a.userData.quaternion.slerp(a.quaternion,.2/n):a.userData.quaternion.copy(a.quaternion)})}this.qbinds.forEach(([i,s,a])=>{let r=a?s.matrixWorld.clone().multiply(a):s.matrixWorld,n=this._tmpQ0.setFromRotationMatrix(i.parent.matrixWorld).invert();i.quaternion.copy(this._tmpQ1.setFromRotationMatrix(r).premultiply(n))})}}},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded);for(let o of this.targetEls)this.el.removeChild(o)}});})();
//# sourceMappingURL=aframe-vrm.min.js.map
