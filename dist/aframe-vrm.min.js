"use strict";class VRMAvatar{constructor(t){this.model=t.scene,this.mixer=new THREE.AnimationMixer(this.model),this.bones={},this.blendShapes={},this.physics=null,this.meta={},this.isVRM=null!=(t.userData.gltfExtensions||{}).VRM,this.animations=t.animations||[],this.lookAtTarget=null,this.t={},this.i=new THREE.Quaternion,this.s=new THREE.Vector3(0,0,-1),this.h=new THREE.Quaternion,this.l=new THREE.Vector3,this.o=[],this.m=t,this.boneConstraints={head:{type:"ball",limit:60*Math.PI/180,twistAxis:new THREE.Vector3(0,1,0),twistLimit:60*Math.PI/180},neck:{type:"ball",limit:30*Math.PI/180,twistAxis:new THREE.Vector3(0,1,0),twistLimit:10*Math.PI/180},leftUpperLeg:{type:"ball",limit:170*Math.PI/180,twistAxis:new THREE.Vector3(0,-1,0),twistLimit:Math.PI/2},rightUpperLeg:{type:"ball",limit:170*Math.PI/180,twistAxis:new THREE.Vector3(0,-1,0),twistLimit:Math.PI/2},leftLowerLeg:{type:"hinge",axis:new THREE.Vector3(1,0,0),min:-170*Math.PI/180,max:0*Math.PI/180},rightLowerLeg:{type:"hinge",axis:new THREE.Vector3(1,0,0),min:-170*Math.PI/180,max:0*Math.PI/180}}}async init(){let t=this.m;if(this.m=null,!this.isVRM){if(this.animations.length>0){this.mixer.clipAction(this.animations[0]).setLoop(THREE.LoopOnce,1).play().clampWhenFinished=!0}return this}let e=t.userData.gltfExtensions.VRM,i=this.bones,s=await t.parser.getDependencies("node"),h=await t.parser.getDependencies("mesh");if(this.meta=e.meta,Object.values(e.humanoid.humanBones).forEach(t=>{i[t.bone]=s[t.node]}),e.firstPerson&&e.firstPerson.firstPersonBone&&(this.firstPersonBone=s[e.firstPerson.firstPersonBone]),e.firstPerson&&e.firstPerson.meshAnnotations&&(this.o=e.firstPerson.meshAnnotations.map(t=>({flag:t.firstPersonFlag,mesh:h[t.mesh]}))),e.blendShapeMaster&&this.p(e.blendShapeMaster,h),e.secondaryAnimation&&globalThis.CANNON&&(console.log("init physics",e.secondaryAnimation),this.physics=new VRMPhysicsCannonJS(e.secondaryAnimation,s)),this.model.skeleton=new THREE.Skeleton(Object.values(i)),this.R(),this.animations.length>0){this.mixer.clipAction(t.animations[0]).setLoop(THREE.LoopRepeat,1/0).play().clampWhenFinished=!0}return this}p(t,e){this.blendShapes=(t.blendShapeGroups||[]).reduce((t,i)=>{let s=i.binds.flatMap(t=>{let i=e[t.mesh];return(i.isSkinnedMesh?[i]:i.children.filter(t=>t.isSkinnedMesh)).map(e=>({target:e,index:t.index,weight:t.weight/100}))});return t[(i.presetName||i.name).toUpperCase()]={name:i.name,binds:s},t},{})}R(){let t=this.bones;if(!t.hips)return;let e=t.hips.getWorldPosition(this.l).clone();this.model.traverse(t=>{if(t.isSkinnedMesh){let i=t.getWorldPosition(this.l).sub(e).multiplyScalar(-1),s=i.clone().sub(t.geometry.boundingSphere.center).length()+t.geometry.boundingSphere.radius;t.geometry.boundingSphere.center.copy(i),t.geometry.boundingSphere.radius=s,t.geometry.boundingBox.min.set(i.x-s,i.y-s,i.z-s),t.geometry.boundingBox.max.set(i.x+s,i.y+s,i.z+s)}})}tick(t){if(this.mixer.update(t),this.lookAtTarget&&this.firstPersonBone){let t=this.firstPersonBone,e=t.worldToLocal(this.l.setFromMatrixPosition(this.lookAtTarget.matrixWorld)).normalize(),i=this.h.setFromUnitVectors(this.s,e),s=this.boneConstraints.head.limit,h=.08,n=2*Math.acos(i.w);n>1.5*s?(i=this.i,h=.04):n>s&&i.setFromAxisAngle(this.l.copy(i).normalize(),s),t.quaternion.slerp(i,h)}this.physics&&this.physics.world&&this.physics.update(t)}setBlendShapeWeight(t,e){this.t[t]=e,0==e&&delete this.t[t],this.u()}getBlendShapeWeight(t){return this.t[t]||0}resetBlendShape(){this.t={},this.u()}startBlink(t){this.animatedMorph||(this.animatedMorph={name:"BLINK",times:[0,t-.2,t-.1,t],values:[0,0,1,0]},this.u())}stopBlink(){this.animatedMorph=null,this.u()}setFirstPerson(t){this.o.forEach(e=>{"ThirdPersonOnly"==e.flag?e.mesh.visible=!t:"FirstPersonOnly"==e.flag?e.mesh.visible=t:"Auto"==e.flag&&this.firstPersonBone&&(t?this.g(e.mesh):this.N(e.mesh))})}getPose(t){let e={};return e.bones=Object.keys(this.bones).map(t=>({name:t,q:this.bones[t].quaternion.toArray()})),t&&(e.blendShape=Object.keys(this.blendShapes).map(t=>({name:t,value:this.getBlendShapeWeight(t)}))),e}setPose(t){if(t.bones)for(let e of t.bones)this.bones[e.name]&&this.bones[e.name].quaternion.fromArray(e.q);if(t.blendShape)for(let e of t.blendShape)this.setBlendShapeWeight(e.name,e.value)}restPose(){for(let t of Object.values(this.bones))t.quaternion.set(0,0,0,1)}g(t){if(t.children.forEach(t=>this.g(t)),t.isSkinnedMesh){let e={};this.firstPersonBone.traverse(t=>{e[t.uuid]=!0});let i=t.skeleton.bones,s=t.geometry.attributes.skinIndex,h=t.geometry.attributes.skinWeight,n=t.geometry.index,l=[],o=0,r=0;for(let t=0;t<s.array.length;t++){h.array[t]>0&&e[i[s.array[t]].uuid]&&(l[t/s.itemSize|0]||(o++,l[t/s.itemSize|0]=!0))}let a=[];for(let t=0;t<n.count;t++)l[n.array[t]]&&!a[t/3|0]&&(a[t/3|0]=!0,r++);if(0==r)return;if(3*r==n.count)return void(t.visible=!1)}}N(t){t.children.forEach(t=>this.N(t)),t.visible=!0}u(){let t=(t,e,i)=>{let s=this.blendShapes[e];s&&s.binds.forEach(e=>{let s=e.target.name,h=t[s]||(t[s]=new Array(e.target.morphTargetInfluences.length*i.length).fill(0));for(let t=0;t<i.length;t++){let s=t*e.target.morphTargetInfluences.length+e.index;h[s]+=Math.max(e.weight*i[t],h[s])}})},e=[0],i={};this.animatedMorph&&(e=this.animatedMorph.times,t(i,this.animatedMorph.name,this.animatedMorph.values));for(let[s,h]of Object.entries(this.t))this.blendShapes[s]&&t(i,s,new Array(e.length).fill(h));let s=Object.entries(i).map(([t,i])=>new THREE.NumberKeyframeTrack(t+".morphTargetInfluences",e,i)),h=null;if(s.length>0){let t=new THREE.AnimationClip("morph",void 0,s);h=this.mixer.clipAction(t).setEffectiveWeight(1).play()}this.morphAction&&this.morphAction.stop(),this.morphAction=h}dispose(){this.physics&&this.physics.detach(),this.physics=null,this.model.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),t.material&&t.material.map&&t.material.map.dispose(),t.skeleton&&t.skeleton.dispose()})}}class VRMPhysicsCannonJS{constructor(t,e){this.collisionGroup=2,this.binds=[],this.fixedBinds=[],this.bodies=[],this.constraints=[],this.h=new THREE.Quaternion,this.l=new THREE.Vector3,this.T=new THREE.Vector3,this.springBoneSystem=this.H(),this.L(t,e)}L(t,e){let i=0;(t.colliderGroups||[]).forEach((t,s)=>{let h=e[t.node];for(let e of t.colliders){let t=new CANNON.Body({mass:0,collisionFilterGroup:1<<this.collisionGroup+s+1,collisionFilterMask:-1});t.addShape(new CANNON.Sphere(.9*e.radius),e.offset),this.bodies.push(t),this.fixedBinds.push([h,t]),i|=t.collisionFilterGroup}});for(let s of t.boneGroups){let t=(new CANNON.Vec3).copy(s.gravityDir||{x:0,y:-1,z:0}).scale(s.gravityPower||0),h=s.hitRadius||.05,n=~(this.collisionGroup|i);for(let t of s.colliderGroups||[])n|=1<<this.collisionGroup+t+1;for(let i of s.bones){let l=new CANNON.Body({mass:0,collisionFilterGroup:0,collisionFilterMask:0});l.position.copy(e[i].parent.getWorldPosition(this.l)),this.bodies.push(l),this.fixedBinds.push([e[i].parent,l]);let o=(e,i)=>{let l=i.getWorldPosition(this.l),r=l.clone(),a=i.children.length+1;i.children.length>0?i.children.forEach(t=>{l.add(t.getWorldPosition(this.T))}):(l.add(i.parent.getWorldPosition(this.T).sub(l).normalize().multiplyScalar(-.1).add(l)),a=2),l.multiplyScalar(1/a);let d=new CANNON.Body({mass:.5,linearDamping:Math.max(s.dragForce||0,1e-4),angularDamping:Math.max(s.dragForce||0,1e-4),collisionFilterGroup:this.collisionGroup,collisionFilterMask:n,position:l});d.addShape(new CANNON.Sphere(h)),this.bodies.push(d);let m=new CANNON.Vec3(0,0,0).copy(this.T.copy(r).sub(l)),f=new CANNON.Vec3(0,0,0).copy(r.sub(e.position)),E=new CANNON.PointToPointConstraint(d,m,e,f);this.constraints.push(E),this.binds.push([i,d]),this.springBoneSystem.objects.push({body:d,parentBody:e,force:t,boneGroup:s,size:h}),i.children.forEach(t=>t.isBone&&o(d,t))};o(l,e[i],0)}}}H(){let t=new CANNON.Quaternion,e=new CANNON.Quaternion,i=new CANNON.Vec3;return{world:null,objects:[],update(){let s=this.world.gravity,h=this.world.dt;for(let n of this.objects){let l=n.body,o=n.parentBody,r=l.force,a=l.mass,d=n.force;r.x+=a*(-s.x+d.x),r.y+=a*(-s.y+d.y),r.z+=a*(-s.z+d.z);let m=l.angularVelocity.length();m>.1&&l.angularVelocity.scale(.1/m,l.angularVelocity);let f=n.boneGroup.stiffiness,E=n.size*n.size*a*1600,p=l.quaternion.mult(o.quaternion.inverse(t),e),[w,R]=p.toAxisAngle(i),u=(R-=2*Math.PI*Math.floor((R+Math.PI)/(2*Math.PI)))*f;Math.abs(u)>Math.abs(R/h/h*25e-5)&&(u=R/h/h*25e-5);let g=w.scale(-u*E,w);l.torque.vadd(g,l.torque)}}}}attach(t){this.detach(),this.world=t||new CANNON.World,this.internalWorld=null==t,this.springBoneSystem.world=this.world,this.world.subsystems.push(this.springBoneSystem),this.bodies.forEach(t=>this.world.add(t)),this.constraints.forEach(t=>this.world.addConstraint(t)),this.reset()}detach(){this.world&&(this.world.subsystems=this.world.subsystems.filter(t=>t!=this.springBoneSystem),this.world.constraints=this.world.constraints.filter(t=>!this.constraints.includes(t)),this.world.bodies=this.world.bodies.filter(t=>!this.bodies.includes(t)),this.world=null)}reset(){this.fixedBinds.forEach(([t,e])=>{t.updateWorldMatrix(!0),e.position.copy(t.getWorldPosition(this.l)),e.quaternion.copy(t.parent.getWorldQuaternion(this.h))}),this.binds.forEach(([t,e])=>{t.updateWorldMatrix(!0),e.position.copy(t.getWorldPosition(this.l)),e.quaternion.copy(t.getWorldQuaternion(this.h))})}update(t){this.fixedBinds.forEach(([t,e])=>{e.position.copy(t.getWorldPosition(this.l)),e.quaternion.copy(t.getWorldQuaternion(this.h))}),this.internalWorld&&this.world.step(1/60,t),this.binds.forEach(([t,e])=>{t.quaternion.copy(e.quaternion).premultiply(t.parent.getWorldQuaternion(this.h).inverse())})}}class BVHLoaderWrapper{async load(t,e,i){let{BVHLoader:s}=await import("https://threejs.org/examples/jsm/loaders/BVHLoader.js");return await new Promise((h,n)=>{(new s).load(t,t=>{i.convertBone&&this.convertClip(t.clip,e),t.clip.tracks=t.clip.tracks.filter(t=>!t.name.match(/position/)||t.name.match(e.bones.hips.name)),h(t.clip)})})}convertBoneName(t){return(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace("Spin1","Spin")).replace("Chest1","Chest")).replace("Chest2","UpperChest")).replace("UpLeg","UpperLeg")).replace("LeftLeg","LeftLowerLeg")).replace("RightLeg","RightLowerLeg")).replace("ForeArm","UpperArm")).replace("LeftArm","LeftLowerArm")).replace("RightArm","RightLowerArm")).replace("Collar","Shoulder")).replace("Elbow","LowerArm")).replace("Wrist","Hand")).replace("LeftHip","LeftUpperLeg")).replace("RightHip","RightUpperLeg")).replace("Knee","LowerLeg")).replace("Ankle","Foot")).charAt(0).toLowerCase()+t.slice(1)}convertClip(t,e){t.tracks.forEach(t=>{t.name=t.name.replace(/bones\[(\w+)\]/,(t,i)=>{let s=e.bones[this.convertBoneName(i)];return"bones["+(null!=s?s.name:"NODE_NOT_FOUND")+"]"}),t.name=t.name.replace("ToeBase","Foot"),t.name.match(/quaternion/)&&(t.values=t.values.map((t,e)=>e%2==0?-t:t)),t.name.match(/position/)&&(t.values=t.values.map((t,e)=>.09*(e%3==1?t:-t)))}),t.tracks=t.tracks.filter(t=>!t.name.match(/NODE_NOT_FOUND/))}}class VMDLoaderWrapper{constructor(){this.boneMapping=[{bone:"hips",nodeNames:["センター","center"]},{bone:"spine",nodeNames:["上半身","upper body"]},{bone:"chest",nodeNames:["上半身2","upper body2"]},{bone:"neck",nodeNames:["首","neck"]},{bone:"head",nodeNames:["頭","head"]},{bone:"leftShoulder",nodeNames:["左肩","shoulder_L"]},{bone:"leftUpperArm",nodeNames:["左腕","arm_L"]},{bone:"leftLowerArm",nodeNames:["左ひじ","elbow_L"]},{bone:"leftHand",nodeNames:["左手首","wrist_L"]},{bone:"rightShoulder",nodeNames:["右肩","shoulder_R"]},{bone:"rightUpperArm",nodeNames:["右腕","arm_R"]},{bone:"rightLowerArm",nodeNames:["右ひじ","elbow_R"]},{bone:"rightHand",nodeNames:["右手首","wrist_R"]},{bone:"leftUpperLeg",nodeNames:["左足","leg_L"]},{bone:"leftLowerLeg",nodeNames:["左ひざ","knee_L"]},{bone:"leftFoot",nodeNames:["左足首","ankle_L"]},{bone:"leftToes",nodeNames:["左つま先","L toe"]},{bone:"rightUpperLeg",nodeNames:["右足","leg_R"]},{bone:"rightLowerLeg",nodeNames:["右ひざ","knee_R"]},{bone:"rightFoot",nodeNames:["右足首","ankle_R"]},{bone:"rightToes",nodeNames:["右つま先","R toe"]},{bone:"leftEye",nodeNames:["左目","eye_L"]},{bone:"rightEye",nodeNames:["右目","eye_R"]},{bone:"leftThumbProximal",nodeNames:["左親指０","thumb0_L"]},{bone:"leftThumbIntermediate",nodeNames:["左親指１","thumb1_L"]},{bone:"leftThumbDistal",nodeNames:["左親指２","thumb2_L"]},{bone:"leftIndexProximal",nodeNames:["左人指１","fore1_L"]},{bone:"leftIndexIntermediate",nodeNames:["左人指２","fore2_L"]},{bone:"leftIndexDistal",nodeNames:["左人指３","fore3_L"]},{bone:"leftMiddleProximal",nodeNames:["左中指１","middle1_L"]},{bone:"leftMiddleIntermediate",nodeNames:["左中指２","middle2_L"]},{bone:"leftMiddleDistal",nodeNames:["左中指３","middle3_L"]},{bone:"leftRingProximal",nodeNames:["左薬指１","third1_L"]},{bone:"leftRingIntermediate",nodeNames:["左薬指２","third2_L"]},{bone:"leftRingDistal",nodeNames:["左薬指３","third3_L"]},{bone:"leftLittleProximal",nodeNames:["左小指１","little1_L"]},{bone:"leftLittleIntermediate",nodeNames:["左小指２","little2_L"]},{bone:"leftLittleDistal",nodeNames:["左小指３","little3_L"]},{bone:"rightThumbProximal",nodeNames:["右親指０","thumb0_R"]},{bone:"rightThumbIntermediate",nodeNames:["右親指１","thumb1_R"]},{bone:"rightThumbDistal",nodeNames:["右親指２","thumb2_R"]},{bone:"rightIndexProximal",nodeNames:["右人指１","fore1_R"]},{bone:"rightIndexIntermediate",nodeNames:["右人指２","fore2_R"]},{bone:"rightIndexDistal",nodeNames:["右人指３","fore3_R"]},{bone:"rightMiddleProximal",nodeNames:["右中指１","middle1_R"]},{bone:"rightMiddleIntermediate",nodeNames:["右中指２","middle2_R"]},{bone:"rightMiddleDistal",nodeNames:["右中指３","middle3_R"]},{bone:"rightRingProximal",nodeNames:["右薬指１","third1_R"]},{bone:"rightRingIntermediate",nodeNames:["右薬指２","third2_R"]},{bone:"rightRingDistal",nodeNames:["右薬指３","third3_R"]},{bone:"rightLittleProximal",nodeNames:["右小指１","little1_R"]},{bone:"rightLittleIntermediate",nodeNames:["右小指２","little2_R"]},{bone:"rightLittleDistal",nodeNames:["右小指３","little3_R"]}],this.blendShapeMap={A:"あ",I:"い",U:"う",E:"え",O:"お",BLINK:"まばたき"},this.rotationOffsets={leftUpperArm:-40*THREE.MathUtils.DEG2RAD,rightUpperArm:40*THREE.MathUtils.DEG2RAD}}async load(t,e,i){let{MMDLoader:s}=await import("https://threejs.org/examples/jsm/loaders/MMDLoader.js"),h=new s,n={};for(let t of this.boneMapping){let i=e.bones[t.bone];if(i)for(let e of t.nodeNames)n[e]=i.name}let l={},o={};for(let[t,i]of Object.entries(this.rotationOffsets)){let s=e.bones[t];s&&(l[s.name]=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,0,1),i),s.traverse(t=>{o[t.name]=[Math.cos(i),Math.sin(i)]}))}let r={};for(let[t,i]of Object.entries(this.blendShapeMap)){e.blendShapes[t]&&(r[i]=t)}e.model.morphTargetDictionary=r;let a=(t,e)=>{[t[0],t[2]]=[t[0]*e[0]-t[2]*e[1],t[0]*e[1]+t[2]*e[0]]},d=(t,e)=>{[t[0],t[1]]=[t[0]*e[0]-t[1]*e[1],t[0]*e[1]+t[1]*e[0]]},m=new THREE.Quaternion,f=new THREE.Quaternion;return await new Promise((i,s)=>{h.loadVMD(t,t=>{let s=t.motions.filter(t=>"下半身"==t.boneName);if(s.length){s.sort((t,e)=>t.frameNum-e.frameNum);let e=(t,e)=>{t.sort((t,e)=>t.frameNum-e.frameNum);let i=0;for(let h of t){for(;i<s.length-1&&h.frameNum>s[i].frameNum;)i++;let t=f.fromArray(s[i].rotation);if(i>0&&h.frameNum<s[i].frameNum){let e=(h.frameNum-s[i-1].frameNum)/(s[i].frameNum-s[i-1].frameNum);t.slerp(m.fromArray(s[i-1].rotation),1-e)}e&&t.invert(),h.rotation=m.fromArray(h.rotation).multiply(t).toArray()}};e(t.motions.filter(t=>"センター"==t.boneName),!1),e(t.motions.filter(t=>"上半身"==t.boneName),!0),s.forEach(t=>t.rotation=[0,0,0,1])}for(let e of t.motions){n[e.boneName]&&(e.boneName=n[e.boneName]);let t=l[e.boneName];t&&(e.rotation=m.fromArray(e.rotation).multiply(t).toArray()),e.position[0]*=.08,e.position[1]*=.08,e.position[2]*=.08,a(e.position,[-1,0]),a(e.rotation,[-1,0]);let i=o[e.boneName];i&&(d(e.position,i),d(e.rotation,i))}let r=h.animationBuilder.build(t,e.model);r.tracks.forEach(t=>{let i=t.name.match(/.morphTargetInfluences\[(\w+)\]/);if(i){let s=e.blendShapes[i[1]];s&&s.binds.length>0&&(t.name=s.binds[0].target.uuid+".morphTargetInfluences["+s.binds[0].index+"]")}}),i(r)},()=>{},s)})}}AFRAME.registerComponent("vrm",{schema:{src:{default:""},firstPerson:{default:!1},blink:{default:!0},blinkInterval:{default:5},lookAt:{type:"selector"},enablePhysics:{default:!1}},init(){this.avatar=null},update(t){let e=this.el,i=this.data;if(i.src!==t.src&&(this.remove(),i.src)){let t=i.src;new THREE.GLTFLoader(THREE.DefaultLoadingManager).load(t,async s=>{let h=await new VRMAvatar(s).init();t==i.src?(this.avatar=h,e.setObject3D("avatar",h.model),this.M(),this.play(),e.emit("model-loaded",{format:"vrm",model:h.model,avatar:h},!1)):h.dispose()},void 0,i=>{e.emit("model-error",{format:"vrm",src:t,cause:i},!1)})}this.M()},tick(t,e){this.avatar?this.avatar.tick(e/1e3):this.pause()},remove(){this.avatar&&(this.el.removeObject3D("avatar"),this.avatar.dispose())},M(){if(!this.avatar)return;let t=this.data;if(this.avatar.setFirstPerson(t.firstPerson),this.avatar.lookAtTarget=t.lookAt?"A-CAMERA"==t.lookAt.tagName?this.el.sceneEl.camera:t.lookAt.object3D:null,t.blink?this.avatar.startBlink(t.blinkInterval):this.avatar.stopBlink(),t.enablePhysics){if(this.avatar.physics&&null==this.avatar.physics.world){let t=null;this.el.sceneEl.systems.physics&&this.el.sceneEl.systems.physics.driver&&(t=this.el.sceneEl.systems.physics.driver.world).bodies.forEach(t=>{1==t.collisionFilterGroup&&1==t.collisionFilterMask&&(t.collisionFilterMask=-1)}),this.avatar.physics&&this.avatar.physics.attach(t)}}else this.avatar.physics&&this.avatar.physics.detach()}}),AFRAME.registerComponent("vrm-bvh",{schema:{src:{default:""},format:{default:""},loop:{default:!0},convertBone:{default:!0}},init(){this.avatar=null,this.el.components.vrm&&this.el.components.vrm.avatar&&(this.avatar=this.el.components.vrm.avatar),this.onVrmLoaded=(t=>{this.avatar=t.detail.avatar,""!=this.data.src?this._(this.data.src):this.avatar.animations.length||this.playTestMotion()}),this.el.addEventListener("model-loaded",this.onVrmLoaded)},update(t){t.src!=this.data.src&&this.avatar&&this._(this.data.src)},async _(t){if(this.stopAnimation(),""===t)return;let e=this.data.loop?THREE.LoopRepeat:THREE.LoopOnce,i="bvh"==(this.data.format||(t.toLowerCase().endsWith(".bvh")?"bvh":""))?new BVHLoaderWrapper:new VMDLoaderWrapper,s=await i.load(t,this.avatar,this.data);this.avatar&&(this.clip=s,this.animation=this.avatar.mixer.clipAction(s).setLoop(e).setEffectiveWeight(1).play())},stopAnimation(){this.animation&&(this.animation.stop(),this.avatar.mixer.uncacheClip(this.clip))},playTestMotion(){let t=(t,e,i)=>(new THREE.Quaternion).setFromEuler(new THREE.Euler(t*Math.PI/180,e*Math.PI/180,i*Math.PI/180)),e={leftUpperArm:{keys:[{rot:t(0,0,65),time:0},{rot:t(0,0,63),time:1},{rot:t(0,0,65),time:2}]},rightUpperArm:{keys:[{rot:t(0,0,-65),time:0},{rot:t(0,0,-60),time:1},{rot:t(0,0,-65),time:2}]},spine:{keys:[{rot:t(0,2,0),time:0},{rot:t(2,0,-2),time:1},{rot:t(2,-2,0),time:2},{rot:t(0,0,2),time:3},{rot:t(0,2,0),time:4}]}},i=THREE.AnimationClip.parseAnimation({name:"testAnimation",hierarchy:Object.values(e)},Object.keys(e).map(t=>this.avatar.bones[t]||{name:t}));this.clip=i,this.animation=this.avatar.mixer.clipAction(i).setEffectiveWeight(1).play()},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this.stopAnimation(),this.avatar=null}}),AFRAME.registerComponent("vrm-skeleton",{schema:{physicsOffset:{type:"vec3",default:{x:0,y:0,z:0}}},init(){this.physicsBodies=[],this.sceneObj=this.el.sceneEl.object3D,this.el.components.vrm&&this.el.components.vrm.avatar&&this.v(this.el.components.vrm.avatar),this.onVrmLoaded=(t=>this.v(t.detail.avatar)),this.el.addEventListener("model-loaded",this.onVrmLoaded)},v(t){this.helper&&this.sceneObj.remove(this.helper),this.helper=new THREE.SkeletonHelper(t.model),this.sceneObj.add(this.helper),this.P(t)},P(t){if(this.C(),!t.physics||!t.physics.world)return;let e=new THREE.SphereGeometry(1,6,3),i=new THREE.MeshBasicMaterial({color:new THREE.Color("red"),wireframe:!0,depthTest:!1});t.physics.bodies.forEach(t=>{let s=new THREE.Group;t.shapes.forEach((h,n)=>{let l=new THREE.Mesh(e,i);l.position.copy(t.shapeOffsets[n]),l.scale.multiplyScalar(h.boundingSphereRadius||.01),s.add(l)}),this.sceneObj.add(s),this.physicsBodies.push([t,s])})},C(){this.physicsBodies.forEach(([t,e])=>e.parent.remove(e)),this.physicsBodies=[]},tick(){this.physicsBodies.forEach(([t,e])=>{e.position.copy(t.position).add(this.data.physicsOffset),e.quaternion.copy(t.quaternion)})},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this.C(),this.helper&&this.sceneObj.remove(this.helper)}}),AFRAME.registerComponent("vrm-poser",{schema:{color:{default:"#00ff00"},enableConstraints:{default:!0}},init(){this.binds=[],this.l=new THREE.Vector3,this.T=new THREE.Vector3,this.h=new THREE.Quaternion,this.k=new THREE.Quaternion,this.F=new THREE.Matrix4,this.el.components.vrm&&this.el.components.vrm.avatar&&this.v(this.el.components.vrm.avatar),this.onVrmLoaded=(t=>this.v(t.detail.avatar)),this.el.addEventListener("model-loaded",this.onVrmLoaded)},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this.B()},getPoseData(t){if(this.avatar)return this.avatar.getPose(t)},setPoseData(t){this.avatar&&(this.avatar.setPose(t),this.D())},v(t){this.B(),this.avatar=t;let e=new THREE.BoxGeometry(1,1,1),i=new THREE.MeshBasicMaterial({color:new THREE.Color(this.data.color),transparent:!0,opacity:.4,depthTest:!1}),s=this.l,h=this.T,n=this.F,l=this.h,o=t.bones.hips,r={};for(let a of Object.keys(t.bones)){let d=t.bones[a],m=d==o,f=new THREE.Mesh(e,i),E=document.createElement("a-entity");E.classList.add("collidable"),E.setAttribute("xy-drag-control",{}),E.setObject3D("handle",f);let p=E.object3D,w=d.children.reduce((t,e)=>Math.min(t,e.position.length()),d.position.length());p.scale.multiplyScalar(Math.max(Math.min(w/2,.05),.01)),r[d.uuid]=a,E.addEventListener("mousedown",t=>{this.el.emit("vrm-poser-select",{name:a,node:d})});let R=d.parent;for(;!r[R.uuid]&&R.parent&&R.parent.isBone;)R=R.parent;E.addEventListener("xy-drag",e=>{if(m){let e=p.parent.worldToLocal(d.getWorldPosition(s)).sub(p.position);t.model.position.sub(e)}R.updateMatrixWorld(!1),p.updateMatrixWorld(!1),n.getInverse(R.matrixWorld).multiply(p.matrixWorld).decompose(h,l,s),d.quaternion.copy(this.j(a,l)),l.setFromUnitVectors(s.copy(d.position).normalize(),h.normalize()),1==R.children.length&&(R.quaternion.multiply(l),this.j(r[R.uuid],R.quaternion)),this.D(m?null:d)}),E.addEventListener("xy-dragend",t=>{this.D(),console.log(R.name,a)}),this.el.appendChild(E),this.binds.push([d,p])}this.D()},j(t,e){if(!this.data.enableConstraints)return e;let i=this.k,s=this.l,h=this.avatar.boneConstraints[t];if(h&&"ball"==h.type){let t=2*Math.acos(e.w);if(h.twistAxis){let n=t*Math.acos(e.w)*s.copy(e).normalize().dot(h.twistAxis);if(n=this.S(n),Math.abs(n)>h.twistLimit){e.multiply(i.setFromAxisAngle(h.twistAxis,-(n<0?n+h.twistLimit:n-h.twistLimit))),t=2*Math.acos(e.w)}}Math.abs(this.S(t))>h.limit&&e.setFromAxisAngle(s.copy(e).normalize(),h.limit)}else if(h&&"hinge"==h.type){let t=(h.min+h.max)/2,i=2*Math.acos(e.w)*s.copy(e).normalize().dot(h.axis);i=THREE.MathUtils.clamp(this.S(i-t),h.min-t,h.max-t),e.setFromAxisAngle(h.axis,i+t)}return e},S:t=>t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI)),B(){this.binds.forEach(([t,e])=>{this.el.removeChild(e.el);let i=e.el.getObject3D("handle");i&&(i.material.dispose(),i.geometry.dispose()),e.el.destroy()}),this.binds=[]},D(t){let e=this.l,i=this.el.object3D;i.updateMatrixWorld(!1);let s=(new THREE.Matrix4).getInverse(i.matrixWorld);this.binds.forEach(([i,h])=>{let n=i==t?e:h.position;i.updateMatrixWorld(!1),h.matrix.copy(i.matrixWorld).premultiply(s).decompose(n,h.quaternion,e)})}});class IKNode{constructor(t,e,i){this.position=t,this.quaternion=new THREE.Quaternion,this.worldMatrix=new THREE.Matrix4,this.worldPosition=new THREE.Vector3,this.constraint=e,this.userData=i}}class IKSolver{constructor(){this.iterationLimit=50,this.thresholdSq=1e-4,this.V=new THREE.Vector3(1,1,1),this.l=new THREE.Vector3,this.T=new THREE.Vector3,this.K=new THREE.Vector3,this.h=new THREE.Quaternion,this.k=new THREE.Quaternion}W(t,e){for(let i of t)i.worldMatrix.compose(i.position,i.quaternion,this.V).premultiply(e),i.worldPosition.setFromMatrixPosition(i.worldMatrix),e=i.worldMatrix}solve(t,e,i){this.W(t,i);let s=t[t.length-1].worldPosition,h=s.distanceToSquared(e),n=this.K,l=this.T,o=this.k;for(let h=0;h<this.iterationLimit&&!(s.distanceToSquared(e)<this.thresholdSq);h++){let s=this.l.copy(e);for(let e=t.length-2;e>=0;e--){let i=t[e],h=t[e+1].position;i.worldMatrix.decompose(this.T,this.h,this.K),n.copy(s).sub(this.T).applyQuaternion(o.copy(this.h).inverse()).normalize(),l.copy(h).normalize(),o.setFromUnitVectors(l,n),i.quaternion.multiply(o);let r=l.copy(h).applyQuaternion(this.h.multiply(o));i.constraint&&(o.copy(i.quaternion).inverse(),i.constraint.apply(i)&&(o.premultiply(i.quaternion),r.copy(h).applyQuaternion(this.h.multiply(o)))),s.sub(r)}this.W(t,i)}return s.distanceToSquared(e)<h}}AFRAME.registerComponent("vrm-mimic",{schema:{leftHandTarget:{type:"selector",default:""},leftHandOffsetPosition:{type:"vec3"},leftHandOffsetRotation:{type:"vec3",default:{x:0,y:-Math.PI/2,z:0}},rightHandTarget:{type:"selector",default:""},rightHandOffsetPosition:{type:"vec3"},rightHandOffsetRotation:{type:"vec3",default:{x:0,y:Math.PI/2,z:0}},leftLegTarget:{type:"selector",default:""},rightLegTarget:{type:"selector",default:""},headTarget:{type:"selector",default:""},avatarOffset:{type:"vec3",default:{x:0,y:0,z:0}}},init(){this.l=new THREE.Vector3,this.T=new THREE.Vector3,this.h=new THREE.Quaternion,this.k=new THREE.Quaternion,this.F=new THREE.Matrix4,this.targetEls=[],this.el.components.vrm&&this.el.components.vrm.avatar&&this.v(this.el.components.vrm.avatar),this.onVrmLoaded=(t=>this.v(t.detail.avatar)),this.el.addEventListener("model-loaded",this.onVrmLoaded)},update(){this.headTarget=this.data.headTarget?"A-CAMERA"==this.data.headTarget.tagName?this.el.sceneEl.camera:this.data.headTarget.object3D:null,this.rightHandOffset=(new THREE.Matrix4).compose(this.data.rightHandOffsetPosition,(new THREE.Quaternion).setFromEuler((new THREE.Euler).setFromVector3(this.data.rightHandOffsetRotation)),new THREE.Vector3(1,1,1)),this.leftHandOffset=(new THREE.Matrix4).compose(this.data.leftHandOffsetPosition,(new THREE.Quaternion).setFromEuler((new THREE.Euler).setFromVector3(this.data.leftHandOffsetRotation)),new THREE.Vector3(1,1,1))},v(t){this.avatar=t;for(let t of this.targetEls)this.el.removeChild(t);this.targetEls=[],this.update(),this.startAvatarIK_simpleIK(t)},startAvatarIK_simpleIK(t){let e=new IKSolver;this.qbinds=[];let i=(e,i,s)=>{null==i&&((i=document.createElement("a-box")).classList.add("collidable"),i.setAttribute("xy-drag-control",{}),i.setAttribute("geometry",{width:.05,depth:.05,height:.05}),i.setAttribute("material",{color:"blue",depthTest:!1,transparent:!0,opacity:.4}),this.el.appendChild(i),this.targetEls.push(i));let h=(e=e.filter(e=>t.bones[e])).map(e=>t.bones[e]),n=h.map((i,s)=>{let n=0==s?i.position:((t,e)=>e.worldToLocal(t.getWorldPosition(new THREE.Vector3)))(i,h[s-1]),l=t.boneConstraints[e[s]];return new IKNode(n,l?{apply:t=>this.j(l,t.quaternion)}:null,i)});return this.qbinds.push([h[h.length-1],i.object3D,s]),{root:h[0],ikbones:n,bones:h,target:i.object3D}};this.chains=[i(["leftUpperArm","leftLowerArm","leftHand"],this.data.leftHandTarget,this.leftHandOffset),i(["rightUpperArm","rightLowerArm","rightHand"],this.data.rightHandTarget,this.rightHandOffset),i(["leftUpperLeg","leftLowerLeg","leftFoot"],this.data.leftLegTarget),i(["rightUpperLeg","rightLowerLeg","rightFoot"],this.data.rightLegTarget)],this.simpleIK=e},j(t,e){let i=this.k,s=this.l,h=!1;if(t&&"ball"==t.type){let n=2*Math.acos(e.w);if(t.twistAxis){let l=n*Math.acos(e.w)*s.copy(e).normalize().dot(t.twistAxis);if(l=this.S(l),Math.abs(l)>t.twistLimit){e.multiply(i.setFromAxisAngle(t.twistAxis,-(l<0?l+t.twistLimit:l-t.twistLimit))),n=2*Math.acos(e.w),h=!0}}Math.abs(this.S(n))>t.limit&&(e.setFromAxisAngle(s.copy(e).normalize(),t.limit),h=!0)}else if(t&&"hinge"==t.type){let i=(t.min+t.max)/2,n=s.copy(e).normalize().dot(t.axis),l=2*Math.acos(e.w)*n;l=THREE.MathUtils.clamp(this.S(l-i),t.min-i,t.max-i),e.setFromAxisAngle(t.axis,l+i),h=!0}return h},S:t=>t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI)),tick(t,e){if(this.avatar){if(this.headTarget){let t=this.l,e=this.h;this.headTarget.matrixWorld.decompose(t,e,this.T),t.y=0,this.avatar.model.position.copy(t.add(this.data.avatarOffset));let i=this.avatar.firstPersonBone;if(i){let t=this.k.setFromRotationMatrix(i.parent.matrixWorld).inverse();i.quaternion.copy(e.premultiply(t))}}if(this.simpleIK){let t=(new THREE.Matrix4).getInverse(this.el.object3D.matrixWorld);for(let e of this.chains){let i=e.root.parent.matrixWorld.clone().premultiply(t);this.simpleIK.solve(e.ikbones,e.target.position,i),e.ikbones.forEach((t,i)=>{if(i==e.ikbones.length-1)return;let s=t.userData.quaternion.angleTo(t.quaternion);s>.2?t.userData.quaternion.slerp(t.quaternion,.2/s):t.userData.quaternion.copy(t.quaternion)})}this.qbinds.forEach(([t,e,i])=>{let s=i?e.matrixWorld.clone().multiply(i):e.matrixWorld,h=this.h.setFromRotationMatrix(t.parent.matrixWorld).inverse();t.quaternion.copy(this.k.setFromRotationMatrix(s).premultiply(h))})}}},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded);for(let t of this.targetEls)this.el.removeChild(t)}});